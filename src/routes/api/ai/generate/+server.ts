import { json, error } from '@sveltejs/kit';
import type { RequestHandler } from './$types';
import { aiService } from '$lib/server/ai-service';
import { WishType, EventType, Language, Relation, AgeGroup } from '$lib/types/Wish';
import { env } from '$env/dynamic/private';

export const POST: RequestHandler = async ({ request, locals }) => {
	try {
		console.log('ü§ñ KI-Generierung API aufgerufen');

		// Pr√ºfe ob OpenRouter API Key konfiguriert ist
		if (!env.OPENROUTER_API_KEY) {
			console.error('‚ùå OPENROUTER_API_KEY nicht konfiguriert');
			throw error(500, 'KI-Service nicht konfiguriert: API-Schl√ºssel fehlt');
		}

		// Authentifizierung pr√ºfen
		const {
			data: { user }
		} = await locals.supabase.auth.getUser();
		if (!user) {
			console.log('‚ùå Benutzer nicht authentifiziert');
			throw error(401, 'Nicht authentifiziert');
		}

		console.log(`‚úÖ Benutzer authentifiziert: ${user.id}`);

		// Benutzerrolle pr√ºfen
		const { data: profile } = await locals.supabase
			.from('profiles')
			.select('role')
			.eq('id', user.id)
			.single();

		if (!profile) {
			console.log('‚ùå Benutzerprofil nicht gefunden');
			throw error(403, 'Benutzerprofil nicht gefunden');
		}

		if (!['Redakteur', 'Administrator'].includes(profile.role)) {
			console.log(`‚ùå Unzureichende Berechtigung: ${profile.role}`);
			throw error(403, 'Keine Berechtigung f√ºr KI-Generierung');
		}

		console.log(`‚úÖ Berechtigung best√§tigt: ${profile.role}`);

		// Request Body parsen und validieren
		const body = await request.json();
		console.log('üìù Request Body:', JSON.stringify(body, null, 2));

		const {
			type,
			eventType,
			language,
			relations,
			ageGroups,
			specificValues,
			style = 'normal',
			count = 1,
			additionalInstructions
		} = body;

		// Validierung der Eingaben
		if (!type || !Object.values(WishType).includes(type)) {
			console.log(`‚ùå Ung√ºltiger Wunsch-Typ: ${type}`);
			throw error(400, 'Ung√ºltiger Wunsch-Typ');
		}

		if (!eventType || !Object.values(EventType).includes(eventType)) {
			console.log(`‚ùå Ung√ºltiger Event-Typ: ${eventType}`);
			throw error(400, 'Ung√ºltiger Event-Typ');
		}

		if (!language || !Object.values(Language).includes(language)) {
			console.log(`‚ùå Ung√ºltige Sprache: ${language}`);
			throw error(400, 'Ung√ºltige Sprache');
		}

		if (!relations || !Array.isArray(relations) || relations.length === 0) {
			console.log(`‚ùå Ung√ºltige Beziehungen: ${relations}`);
			throw error(400, 'Mindestens eine Beziehung muss ausgew√§hlt sein');
		}

		if (!ageGroups || !Array.isArray(ageGroups) || ageGroups.length === 0) {
			console.log(`‚ùå Ung√ºltige Altersgruppen: ${ageGroups}`);
			throw error(400, 'Mindestens eine Altersgruppe muss ausgew√§hlt sein');
		}

		// Validiere relations und ageGroups
		for (const relation of relations) {
			if (!Object.values(Relation).includes(relation)) {
				console.log(`‚ùå Ung√ºltige Beziehung: ${relation}`);
				throw error(400, `Ung√ºltige Beziehung: ${relation}`);
			}
		}

		for (const ageGroup of ageGroups) {
			if (!Object.values(AgeGroup).includes(ageGroup)) {
				console.log(`‚ùå Ung√ºltige Altersgruppe: ${ageGroup}`);
				throw error(400, `Ung√ºltige Altersgruppe: ${ageGroup}`);
			}
		}

		console.log('‚úÖ Eingaben validiert');

		// Count limitieren
		const limitedCount = Math.min(Math.max(1, count), 10); // Zwischen 1 und 10
		console.log(`üìä Anzahl W√ºnsche: ${limitedCount}`);

		// Lade AI-Settings aus der Datenbank
		console.log('üîß Lade KI-Einstellungen...');
		const { data: userSettings, error: settingsError } = await locals.supabase
			.from('user_settings')
			.select(
				'ai_prompt_system, ai_prompt_template, ai_model, ai_temperature, ai_max_tokens, ai_top_p, ai_frequency_penalty, ai_presence_penalty'
			)
			.eq('user_id', user.id)
			.single();

		if (settingsError) {
			console.log('‚ö†Ô∏è Keine benutzerdefinierten KI-Einstellungen gefunden, verwende Defaults');
		} else {
			console.log('‚úÖ KI-Einstellungen geladen');
		}

		const aiSettings = userSettings
			? {
					// eslint-disable-next-line @typescript-eslint/no-explicit-any
					promptSystem: (userSettings as any).ai_prompt_system,
					// eslint-disable-next-line @typescript-eslint/no-explicit-any
					promptTemplate: (userSettings as any).ai_prompt_template,
					// eslint-disable-next-line @typescript-eslint/no-explicit-any
					model: (userSettings as any).ai_model,
					// eslint-disable-next-line @typescript-eslint/no-explicit-any
					temperature: (userSettings as any).ai_temperature,
					// eslint-disable-next-line @typescript-eslint/no-explicit-any
					maxTokens: (userSettings as any).ai_max_tokens,
					// eslint-disable-next-line @typescript-eslint/no-explicit-any
					topP: (userSettings as any).ai_top_p,
					// eslint-disable-next-line @typescript-eslint/no-explicit-any
					frequencyPenalty: (userSettings as any).ai_frequency_penalty,
					// eslint-disable-next-line @typescript-eslint/no-explicit-any
					presencePenalty: (userSettings as any).ai_presence_penalty
				}
			: undefined;

		console.log('ü§ñ Starte KI-Generierung...');

		// KI-Generierung mit User-Tracking und Custom-Settings
		const result = await aiService.generateWishes(
			{
				type,
				eventType,
				language,
				relations,
				ageGroups,
				specificValues: specificValues || [],
				style,
				count: limitedCount,
				additionalInstructions
			},
			user.id,
			aiSettings
		);

		if (result.error) {
			console.error('‚ùå KI-Generierungsfehler:', result.error);
			throw error(500, `KI-Generierungsfehler: ${result.error}`);
		}

		console.log(`‚úÖ KI-Generierung erfolgreich: ${result.totalGenerated} W√ºnsche generiert`);

		return json({
			success: true,
			wishes: result.wishes,
			totalGenerated: result.totalGenerated,
			message: `${result.totalGenerated} W√ºnsche erfolgreich generiert`
		});
	} catch (err) {
		console.error('‚ùå API Error in /api/ai/generate:', err);

		// Wenn es bereits ein SvelteKit-Error ist, weiterwerfen
		if (err && typeof err === 'object' && 'status' in err) {
			throw err;
		}

		// Andernfalls als interner Server-Fehler behandeln
		const errorMessage = err instanceof Error ? err.message : 'Unbekannter Fehler bei der KI-Generierung';
		console.error('‚ùå Interner Server-Fehler:', errorMessage);
		throw error(500, `Interner Server-Fehler: ${errorMessage}`);
	}
};

// Health-Check-Endpunkt
export const GET: RequestHandler = async ({ locals }) => {
	try {
		console.log('üîç Health-Check f√ºr KI-Service');

		// Pr√ºfe Environment-Variablen
		const hasApiKey = !!env.OPENROUTER_API_KEY;
		console.log(`üîë OpenRouter API Key: ${hasApiKey ? 'vorhanden' : 'fehlt'}`);

		if (!hasApiKey) {
			return json({
				status: 'unhealthy',
				service: 'OpenRouter AI',
				error: 'API-Schl√ºssel nicht konfiguriert',
				timestamp: new Date().toISOString()
			});
		}

		// Authentifizierung pr√ºfen
		const {
			data: { user }
		} = await locals.supabase.auth.getUser();
		if (!user) {
			throw error(401, 'Nicht authentifiziert');
		}

		// Health-Check der AI-API
		const healthResult = await aiService.checkHealth();
		console.log(`ü§ñ AI-Service Health: ${healthResult.healthy ? 'gesund' : 'ungesund'} - ${healthResult.details}`);

		return json({
			status: healthResult.healthy ? 'healthy' : 'unhealthy',
			service: 'OpenRouter AI',
			details: healthResult.details,
			models: healthResult.models,
			hasApiKey,
			timestamp: new Date().toISOString()
		});
	} catch (err) {
		console.error('‚ùå Health check error:', err);
		throw error(500, 'Health check fehlgeschlagen');
	}
};
